<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="theme-color" content="#0B2C5F" />
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>Reset Password | Contract Marketing Hub</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0B2C5F',
                        darkbg: '#081A33',
                        accent: '#F59E0B'
                    }
                }
            }
        }
    </script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(to bottom, #081A33, #0B2C5F);
        }

        /* Hide Google Translate UI junk */
        .goog-logo-link,
        .goog-te-banner-frame,
        .goog-te-gadget,
        #goog-gt-tt,
        body>.skiptranslate {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="page-root" class="min-h-screen flex items-center justify-center px-4 text-gray-100">

        <div class="w-full max-w-md bg-white text-gray-800 rounded-xl shadow p-6">

            <h1 class="text-2xl font-bold text-center text-primary mb-2">
                Reset Password
            </h1>
            <p class="text-center text-gray-500 text-sm mb-4">
                Create a new password for your account
            </p>

            <!-- LANGUAGE SELECT (STABLE) -->
            <div class="mb-4 flex justify-center">
                <select id="langSelect"
                    class="bg-gray-100 text-sm rounded px-3 py-1 border border-gray-300 cursor-pointer">
                    <option value="">Select Language</option>
                    <option value="en">English</option>
                    <option value="pt">Portuguese</option>
                    <option value="de">German</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="da">Danish</option>
                </select>
            </div>

            <div id="messageBox" class="hidden mb-4 p-3 rounded text-sm"></div>

            <form id="resetForm" class="space-y-4">

                <div>
                    <label class="block text-sm font-medium mb-1">New Password</label>
                    <input type="password" id="password" minlength="8" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" />
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" minlength="8" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" />
                </div>

                <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg font-medium">
                    Reset Password
                </button>
            </form>

            <p class="mt-5 text-center text-sm text-gray-500">
                Remembered your password?
                <a href="./login.html" class="text-primary font-medium">Login</a>
            </p>
        </div>
    </div>

    <!-- GOOGLE TRANSLATE ENGINE -->
    <div id="google_translate_element" style="display:none"></div>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        /* Prevent logged-in users */
        const existingToken = localStorage.getItem('token');
        const existingUser = localStorage.getItem('user');
        if (existingToken && existingUser) {
            const user = JSON.parse(existingUser);
            location.href = user.role === 'admin'
                ? '../admin/dashboard.html'
                : '../user/dashboard.html';
        }

        const form = document.getElementById('resetForm');
        const messageBox = document.getElementById('messageBox');
        const submitBtn = form.querySelector('button');

        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (!token) {
            showError('Invalid or missing reset token.');
            submitBtn.disabled = true;
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();
            resetMessage();

            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (password.length < 8) return showError('Password must be at least 8 characters.');
            if (password !== confirm) return showError('Passwords do not match.');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';

            try {
                const res = await fetch(
                    `http://localhost:5000/api/auth/reset-password/${token}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    }
                );

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Reset failed');

                showSuccess('Password reset successful. Redirecting...');
                setTimeout(() => location.href = './login.html', 1500);

            } catch (err) {
                showError(err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        });

        function resetMessage() {
            messageBox.className = 'hidden mb-4 p-3 rounded text-sm';
        }
        function showError(msg) {
            messageBox.textContent = msg;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('bg-red-100', 'text-red-700');
        }
        function showSuccess(msg) {
            messageBox.textContent = msg;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('bg-green-100', 'text-green-700');
        }

        /* GOOGLE TRANSLATE (COOKIE-BASED, STABLE) */
        function googleTranslateElementInit() {
            new google.translate.TranslateElement(
                { pageLanguage: 'en', includedLanguages: 'en,pt,de,fr,es,da', autoDisplay: false },
                'google_translate_element'
            );
        }

        document.getElementById('langSelect').addEventListener('change', function () {
            const lang = this.value;
            if (!lang) return;

            if (lang === 'en') {
                document.cookie = 'googtrans=;path=/;';
                document.cookie = 'googtrans=;path=/;domain=' + location.hostname;
            } else {
                const val = `/en/${lang}`;
                document.cookie = `googtrans=${val};path=/;`;
                document.cookie = `googtrans=${val};path=/;domain=${location.hostname}`;
            }
            location.reload();
        });
    </script>
</body>

</html>