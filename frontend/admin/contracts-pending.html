<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin · Pending Contracts</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0B2C5F',
                        darkbg: '#081A33',
                        accent: '#F59E0B'
                    }
                }
            }
        };
    </script>
</head>

<body class="min-h-screen bg-gradient-to-b from-darkbg to-primary text-gray-100">

    <!-- HEADER -->
    <header class="sticky top-0 z-50 bg-darkbg/90 backdrop-blur border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="font-bold text-lg">Admin · Pending Contracts</h1>
            <a href="./dashboard.html" class="text-sm text-accent">← Back to Dashboard</a>
        </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-7xl mx-auto px-4 py-8">

        <div class="bg-white text-gray-800 rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Contracts Awaiting Approval</h2>

            <div id="messageBox" class="hidden mb-4 p-3 rounded text-sm"></div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border">User</th>
                            <th class="p-2 border">Email</th>
                            <th class="p-2 border">Contract</th>
                            <th class="p-2 border">Entry</th>
                            <th class="p-2 border">Expected ROI</th>
                            <th class="p-2 border">Requested</th>
                            <th class="p-2 border">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contractsBody">
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-500">
                                Loading pending contracts…
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="mt-12 border-t border-white/10 text-center py-6 text-sm text-gray-300">
        © <span id="year"></span> Contract Marketing Hub
    </footer>

    <script>
        const API_BASE_URL = window.location.origin;
    </script>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const token = localStorage.getItem('token');
        if (!token) {
            localStorage.clear();
            location.href = '../auth/login.html';
        }

        const tbody = document.getElementById('contractsBody');
        const messageBox = document.getElementById('messageBox');

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = 'mb-4 p-3 rounded text-sm';
            messageBox.classList.remove('hidden');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100');
                messageBox.classList.add('text-green-700');
            } else {
                messageBox.classList.add('bg-red-100');
                messageBox.classList.add('text-red-700');
            }
        }

        async function loadPendingContracts() {
            try {
                const res = await fetch(
                    `${API_BASE_URL}/api/admin/contracts/pending`,
                    { headers: { Authorization: 'Bearer ' + token } }
                );

                const data = await res.json();
                tbody.innerHTML = '';

                if (!res.ok) {
                    throw new Error(data.message || 'Failed to load contracts');
                }

                if (!data.contracts.length) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-500">
                                No pending contracts
                            </td>
                        </tr>`;
                    return;
                }

                data.contracts.forEach(c => {
                    const symbol = c.user.currencySymbol || '';
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td class="p-2 border">${c.user.name}</td>
                        <td class="p-2 border">${c.user.email}</td>
                        <td class="p-2 border">${c.contractPlan.name}</td>
                        <td class="p-2 border">${symbol}${Number(c.entryAmount).toLocaleString()}</td>
                        <td class="p-2 border">${symbol}${Number(c.expectedPayout).toLocaleString()}</td>
                        <td class="p-2 border">${new Date(c.createdAt).toLocaleDateString()}</td>
                        <td class="p-2 border space-x-2">
                            <button
                                onclick="activateContract('${c._id}')"
                                class="bg-green-600 text-white px-3 py-1 rounded text-xs">
                                Activate
                            </button>
                            <button
                                onclick="rejectContract('${c._id}')"
                                class="bg-red-600 text-white px-3 py-1 rounded text-xs">
                                Reject
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-4 text-center text-red-500">
                            Failed to load pending contracts
                        </td>
                    </tr>`;
            }
        }

        async function activateContract(id) {
            if (!confirm('Activate this contract?')) return;

            try {
                const res = await fetch(
                    `${API_BASE_URL}/api/admin/contracts/${id}/activate`,
                    {
                        method: 'POST',
                        headers: { Authorization: 'Bearer ' + token }
                    }
                );

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Activation failed');
                }

                showMessage(data.message || 'Contract activated successfully');
                loadPendingContracts();

            } catch (err) {
                showMessage(err.message, 'error');
            }
        }

        async function rejectContract(id) {
            if (!confirm('Reject this contract?')) return;

            try {
                const res = await fetch(
                    `${API_BASE_URL}/api/admin/contracts/${id}/reject`,
                    {
                        method: 'POST',
                        headers: { Authorization: 'Bearer ' + token }
                    }
                );
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Rejection failed');
                }

                showMessage(data.message || 'Contract rejected');
                loadPendingContracts();

            } catch (err) {
                showMessage(err.message, 'error');
            }
        }

        loadPendingContracts();
    </script>

</body>

</html>