<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0B2C5F" />
    <title>Admin · Users</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0B2C5F',
                        darkbg: '#081A33',
                        accent: '#F59E0B'
                    }
                }
            }
        };
    </script>

    <style>
        html,
        body {
            overflow-x: hidden;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-b from-darkbg to-primary text-gray-100">

    <!-- HEADER -->
    <header class="sticky top-0 z-50 bg-darkbg/90 backdrop-blur border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="font-bold text-lg">Admin · Users</h1>
            <a href="/admin/dashboard.html" class="text-sm text-accent">← Back to Dashboard</a>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 max-w-7xl mx-auto px-4 py-10 w-full">

        <!-- SEARCH -->
        <div class="mb-4">
            <input id="searchInput" type="text" placeholder="Search by name, email, phone…"
                class="w-full md:w-1/2 px-4 py-2 rounded-lg text-gray-800 outline-none" />
        </div>

        <!-- MESSAGE -->
        <div id="messageBox" class="hidden mb-4 p-3 rounded text-sm"></div>

        <!-- USERS TABLE -->
        <div class="bg-white text-gray-800 rounded-xl shadow overflow-x-auto">
            <table class="w-full text-sm border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border">Name</th>
                        <th class="p-2 border">Email</th>
                        <th class="p-2 border">Phone</th>
                        <th class="p-2 border">Balance</th>
                        <th class="p-2 border">Entry Cost</th>
                        <th class="p-2 border">Expected Earnings</th>
                        <th class="p-2 border">Action</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-500">
                            Loading users…
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="border-t border-white/10 text-center py-4 text-sm text-gray-300">
        © <span id="year"></span> Contract Marketing Hub
    </footer>

    <script>
        const API_BASE_URL = window.location.origin;

        document.getElementById('year').textContent = new Date().getFullYear();

        const token = localStorage.getItem('token');
        if (!token) {
            localStorage.clear();
            location.href = '/auth/login.html';
        }

        const usersBody = document.getElementById('usersBody');
        const messageBox = document.getElementById('messageBox');
        const searchInput = document.getElementById('searchInput');

        let allUsers = [];

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = 'mb-4 p-3 rounded text-sm';
            messageBox.classList.remove('hidden');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            }
        }

        function renderUsers(users) {
            usersBody.innerHTML = '';

            if (!users.length) {
                usersBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-500">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 border">${u.name || '—'}</td>
                    <td class="p-2 border">${u.email || '—'}</td>
                    <td class="p-2 border">${u.phone || '—'}</td>

                    <td class="p-2 border">
                        <input type="number" class="w-24 border px-2 py-1 rounded"
                            value="${u.balance ?? 0}" id="bal-${u._id}">
                    </td>

                    <td class="p-2 border">
                        <input type="number" class="w-24 border px-2 py-1 rounded"
                            value="${u.entryCost ?? 0}" id="entry-${u._id}">
                    </td>

                    <td class="p-2 border">
                        <input type="number" class="w-24 border px-2 py-1 rounded"
                            value="${u.expectedEarnings ?? 0}" id="earn-${u._id}">
                    </td>

                    <td class="p-2 border">
                        <button
                            onclick="saveUser('${u._id}')"
                            class="bg-primary text-white px-3 py-1 rounded text-xs">
                            Save
                        </button>
                    </td>
                `;
                usersBody.appendChild(tr);
            });
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: {
                        Authorization: 'Bearer ' + token
                    }
                });

                if (!res.ok) throw new Error();

                const data = await res.json();
                allUsers = data.users || [];
                renderUsers(allUsers);

            } catch {
                usersBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-4 text-center text-red-500">
                            Failed to load users
                        </td>
                    </tr>
                `;
            }
        }

        async function saveUser(id) {
            try {
                const body = {
                    balance: document.getElementById(`bal-${id}`).value,
                    entryCost: document.getElementById(`entry-${id}`).value,
                    expectedEarnings: document.getElementById(`earn-${id}`).value
                };

                const res = await fetch(
                    `${API_BASE_URL}/api/admin/users/${id}/financials`,
                    {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: 'Bearer ' + token
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (!res.ok) throw new Error();

                showMessage('User financials updated successfully');

            } catch {
                showMessage('Failed to update user', 'error');
            }
        }

        searchInput.addEventListener('input', e => {
            const q = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u =>
                (u.name || '').toLowerCase().includes(q) ||
                (u.email || '').toLowerCase().includes(q) ||
                (u.phone || '').toLowerCase().includes(q)
            );
            renderUsers(filtered);
        });

        loadUsers();
    </script>

</body>

</html>